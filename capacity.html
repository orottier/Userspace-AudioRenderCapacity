<!DOCTYPE html>
<html>
    <head>
        <title>User space AudioRenderCapacity</title>
    </head>
    <body>
        <button id='start'>Start</button>
        <button id='measure'>Measure</button>
        <button id='stop'>Stop</button>

<script type='text/javascript'>
var started;

var startButton = document.getElementById("start")
var maxFlops = 0, realLoad = 0.;

startButton.onclick = async () => {
    console.log('play');
    if (started) {
        return false;
    }
    started = true;
    console.log('starting');
    startButton.disabled = true;

    context = new (window.AudioContext || window.webkitAudioContext)();
    context.resume();

    console.log(context.sampleRate);

    await context.audioWorklet.addModule("proc.js");

    source = new AudioWorkletNode(
        context,
        "render-capacity-processor",
        { "numberOfInputs": 0 }
    );
    source.connect(context.destination);

    source.port.onmessage = event => {
        console.log("msg", event.data);
        if (event.data.max_flops) {
            maxFlops = event.data.max_flops;
            console.log("maxFlops", maxFlops);
            source.port.postMessage({ state: 2 })
        } else if (event.data.load_factor) {
            if (!realLoad) {
                realLoad = event.data.load_factor;
                console.log("realLoad", realLoad);
            } else {
                var curLoad = Math.max(1 - event.data.load_factor / realLoad, 0) * 100;
                console.log("curLoad", curLoad);
            }
        }
    }
    source.port.onmessageerror = (e) => {
        console.log('control msg error', e)
    }

    var measureButton = document.getElementById("measure");
    measureButton.addEventListener('click', () => {
        measureButton.disabled = true;
        source.port.postMessage({ state: 2 })
        setInterval(() => source.port.postMessage({ state: 2 }), 500);
    });

    var stopButton = document.getElementById("stop");
    stopButton.addEventListener('click', () => {
        stopButton.disabled = true;
        context.close();
    });

    source.port.postMessage({ state: 1 });
};
</script>
    </body>
</html>
