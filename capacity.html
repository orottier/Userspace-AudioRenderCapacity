<!DOCTYPE html>
<html>
    <head>
        <title>User space AudioRenderCapacity</title>
    </head>
    <body>
        <h1>Experimental: AudioRenderCapacity implemented in user space web audio</h1>
        <p>Hit Start when idle for a baseline measurement.</p>
        <p>Click Measure to determine the load twice per second.</p>
        <div>
            <button id='start'>Start</button>
            <button id='measure'>Measure</button>
            <button id='stop'>Stop</button>
        </div>

        <textarea style='width: 80em; height: 20em' id='logBox'></textarea>

<script type='text/javascript'>
var started;

var startButton = document.getElementById("start")
var logBox = document.getElementById("logBox")
logBox.value = '';
var maxFlops = 0, realLoad = 0.;

function log(text) {
    logBox.value = new Date().toLocaleString() + " > " + text + "\n" + logBox.value;
}

startButton.onclick = async () => {
    console.log('play');
    if (started) {
        return false;
    }
    started = true;
    console.log('starting');
    startButton.disabled = true;

    context = new (window.AudioContext || window.webkitAudioContext)();
    context.resume();

    console.log(context.sampleRate);

    await context.audioWorklet.addModule("proc.js");

    source = new AudioWorkletNode(
        context,
        "render-capacity-processor",
        { "numberOfInputs": 0 }
    );
    source.connect(context.destination);

    source.port.onmessage = event => {
        console.log("msg", event.data);
        if (event.data.max_flops) {
            maxFlops = event.data.max_flops;
            log("max flops: " + maxFlops);
            source.port.postMessage({ state: 2 })
        } else if (event.data.load_factor) {
            if (!realLoad) {
                realLoad = event.data.load_factor;
                log("flop correction: " + Math.round(realLoad * 100, 2) / 100)
            } else {
                var curLoad = Math.max(1 - event.data.load_factor / realLoad, 0) * 100;
                log("current load: " + Math.round(curLoad, 2) + "%");
            }
        }
    }
    source.port.onmessageerror = (e) => {
        console.log('control msg error', e)
    }

    var measureButton = document.getElementById("measure");
    measureButton.addEventListener('click', () => {
        measureButton.disabled = true;
        source.port.postMessage({ state: 2 })
        setInterval(() => source.port.postMessage({ state: 2 }), 500);
    });

    var stopButton = document.getElementById("stop");
    stopButton.addEventListener('click', () => {
        stopButton.disabled = true;
        context.close();
    });

    source.port.postMessage({ state: 1 });
};
</script>
    </body>
</html>
