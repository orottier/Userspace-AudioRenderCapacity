<!DOCTYPE html>
<html>
    <head>
        <title>User space AudioRenderCapacity</title>
    </head>
    <body>
        <button id='start'>Start</button>
        <button id='measure'>Measure</button>
        <button id='stop'>Stop</button>

<script type='text/javascript'>
var started;

var startButton = document.getElementById("start")
startButton.onclick = async () => {
    console.log('play');
    if (started) {
        return false;
    }
    started = true;
    console.log('starting');
    startButton.disabled = true;

    context = new (window.AudioContext || window.webkitAudioContext)();
    console.log(context.sampleRate);

    await context.audioWorklet.addModule("proc.js");

    source = new AudioWorkletNode(
        context,
        "render-capacity-processor",
    );

    source.connect(context.destination);
    source.port.onmessage = event => {
        console.log("load", event.data.load);
    }
    source.port.onmessageerror = (e) => {
        console.log('control msg error', e)
    }

    var measureButton = document.getElementById("measure");
    measureButton.addEventListener('click', () => {
        measureButton.disabled = true;
    });

    var stopButton = document.getElementById("stop");
    stopButton.addEventListener('click', () => {
        stopButton.disabled = true;
        context.close();
    });

    var sab = new SharedArrayBuffer(Int32Array.BYTES_PER_ELEMENT);
    source.port.postMessage({ state: 1, sab });
    var arr = new Int32Array(sab);

    setTimeout(function () {
        var start = performance.now();
        var count = 0;
        var countUnique = 0;
        var prev = 0;
        do {
            count += 1;
            var now = performance.now();
            if (now != prev) {
                countUnique += 1;
                prev = now;
            } else {
                Atomics.store(arr, 0, (now - start) * 1000);
            }
        } while (now - start < 100);
        console.log("loop times:", count);
        console.log("unique:", countUnique);
    }, 0);
};
</script>
    </body>
</html>
